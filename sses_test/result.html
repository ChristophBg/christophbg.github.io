<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SSES Ergebnis</title>
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
</head>

<body style="max-width:900px;margin:2rem auto;font-family:system-ui,Segoe UI,Arial;">
  <h2>Salzburg Stress Eating Scale (SSES)</h2>

  <div id="txt"></div>
  <div id="plot" style="height:420px;"></div>

<script>
  function getHashParam(key){
    const h = (location.hash || "").replace(/^#/, "");
    return new URLSearchParams(h).get(key);
  }

  const txt = document.getElementById("txt");

  const score = Number(getHashParam("score"));
  const gRaw  = (getHashParam("g") || "").toLowerCase();
  const age   = Number(getHashParam("age"));

  // --- display score text ---
  if (!Number.isFinite(score)) {
    txt.innerHTML = `<p><b>Kein Score gefunden.</b> Bitte den Fragebogen über den Start-Link ausfüllen.</p>`;
  } else {
    const mean = score / 10;
    txt.innerHTML = `
      <p><b>Total:</b> ${score} (Range 10–50)</p>
      <p><b>Mittelwert pro Item:</b> ${mean.toFixed(2)} (1–5)</p>
      <p><b>Hinweis:</b> Höhere Werte = tendenziell mehr essen unter Stress; niedrigere Werte = tendenziell weniger.</p>
      <p style="opacity:.85">Kein Diagnoseinstrument. Ergebnisse dienen nur der Orientierung.</p>
    `;
  }

  // --- helpers ---
  function ageBand(a){
    if (!Number.isFinite(a) || a < 0 || a > 120) return null;
    if (a < 18) return "a00_17";
    if (a <= 29) return "a18_29";
    if (a <= 44) return "a30_44";
    if (a <= 59) return "a45_59";
    return "a60_120";
  }

  function genderLabel(code){
    if (code === "m") return "männlich";
    if (code === "f") return "weiblich";
    if (code === "d") return "divers";
    return "keine Angabe";
  }

  const band = ageBand(age);
  const allowedG = new Set(["m","f","d"]); // matches LimeSurvey codes
  const minN = 80; // if stratum n < minN -> fallback to all

  async function fetchJson(relPath){
    const baseUrl = window.location.href.split("#")[0];
    const url = new URL(relPath, baseUrl).toString() + "?v=" + Date.now(); // cache-bust
    const r = await fetch(url, { cache: "no-store" });
    if (!r.ok) throw new Error(`HTTP ${r.status} for ${relPath}`);
    return await r.json();
  }

  async function loadNorm(){
    // Special rule: for "d" (diverse) show note + use overall norms
    if (gRaw === "d") {
      const norm = await fetchJson("./norms/all.json");
      return {
        norm,
        refText: "Gesamtnorm",
        note: "Für die Kategorie „divers“ liegen derzeit nicht genügend Referenzdaten für eine separate Normkurve vor. Daher wird die Gesamtnorm angezeigt."
      };
    }

    // Try stratified only for m/f and valid age band
    if (allowedG.has(gRaw) && (gRaw === "m" || gRaw === "f") && band) {
      const stratumPath = `./norms/${gRaw}_${band}.json`;
      try {
        const j = await fetchJson(stratumPath);
        if (j?.kde?.x?.length && j?.kde?.y?.length && (j.n ?? 0) >= minN) {
          return {
            norm: j,
            refText: `Norm: ${genderLabel(gRaw)}, ${band.replace("a","").replace("_","–")} (n=${j.n})`
          };
        }
      } catch (e) {
        // ignore and fallback
      }
    }

    // Fallback overall
    const all = await fetchJson("./norms/all.json");
    return {
      norm: all,
      refText: `Gesamtnorm (n=${all.n ?? "?"})`
    };
  }

  // --- load norms and plot ---
  loadNorm()
    .then(({norm, refText, note}) => {
      if (!norm?.kde?.x?.length || !norm?.kde?.y?.length) {
        throw new Error("Norm-JSON hat nicht das erwartete Format {kde:{x:[],y:[]}}.");
      }
      if (norm.kde.x.length !== norm.kde.y.length) {
        throw new Error("Norm-JSON: kde.x und kde.y haben unterschiedliche Längen.");
      }

      const x = norm.kde.x;
      const y = norm.kde.y;

      const data = [{
        x, y,
        mode: "lines",
        name: "Referenzverteilung"
      }];

      const layout = {
        margin: { t: 20, r: 20, b: 60, l: 60 },
        xaxis: { title: "SSES Total", range: [10, 50] },
        yaxis: { title: "Dichte" },
        shapes: Number.isFinite(score) ? [{
          type: "line",
          x0: score, x1: score,
          y0: 0, y1: 1,
          yref: "paper",
          line: { width: 3 }
        }] : [],
        annotations: Number.isFinite(score) ? [{
          x: score, y: 1, yref: "paper",
          text: "Ihr Wert",
          showarrow: false,
          yanchor: "bottom"
        }] : []
      };

      Plotly.newPlot("plot", data, layout, { displayModeBar: false });

      // show reference info (non-debug)
      txt.innerHTML += `<p style="opacity:.85"><b>${refText}</b></p>`;
      if (note) txt.innerHTML += `<p style="opacity:.85"><b>Hinweis:</b> ${note}</p>`;
    })
    .catch((err) => {
      console.error(err);
      txt.innerHTML += `
        <p style="color:#b00"><b>Normdaten konnten nicht geladen werden:</b> ${err.message}</p>
        <p style="opacity:.7">Prüfe: <code>sses_test/norms/all.json</code> ist gültiges JSON und liegt im richtigen Pfad.</p>
      `;
    });
</script>
</body>
</html>
